<html>
<head>
    <meta charset="utf-8"/>
    <style>
        @font-face {
            font-family: 'Palui';
            src: url('static/css/fonts/palui.ttf') format("truetype");
        }

        body {
            background-image: url('/static/images/background.png');
        }
    </style>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <title>Инвест INFCOIN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
</head>
<body>
<div class="frame_r">
    <div class="header">
        <div class="center_header">
            <div class="header_left">
                <img style="width: 70px;height: 70px" src="static/images/logo.svg">
                <p class="main_text">ИНВЕСТИЦИИ<br>БЕСКОНЕЧНОСТИ</p>
            </div>
            <div class="header_right">
                <div class="block_menu-inactive" style="margin-left: 20px">
                    <img style="height: 42px;width: 42px;margin-left: 12px;" src="static/images/RUB.png" />
                    <p id="valut_in_rubbles" style="font-family: Montserrat; font-size: 20px; padding: 40px 30px 40px 16px"></p>
                </div>
                <div id="profileClick" class="block_menu-inactive" style="margin-left: 20px">
                    <p>{{ username }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="main_container_of_exchange">
        <div class="exchange_container">
            <div class="exchange_left">
                <p style="font-size: 24px;margin-top: 0px;margin-left: 0px" class="main_text">Добрый вечер</p>
                <div class="valutdiv">
                    <div style="display: flex" class="valut_left">
                        <img src="/static/images/search.png"/>
                        <input type="text" id="assetSearch" placeholder="Поиск актива" class="search-input">
                    </div>
                </div>
                <div id="inf" class="valutdiv">
                    <div style="display: flex" class="valut_left">
                        <img src="/static/images/infcoin.png"/>
                        <p> {{ inf }} INFCOIN</p>
                    </div>
                    <p class="invest_up">+∞ %</p>
                </div>
            </div>
            <div style="height: 710px" class="exchange_right">
                <div class="top_of_exchange">
                    <img id="valut_icon" src="/static/images/infcoin.png"/>
                    <p id="name_of_valut" style="color: white">INFCOIN</p>
                    <p id="valut_change_percent" style="margin-left: 50px" class="invest_up">+∞ %*</p>
                </div>
                <div class="under_top_of_exchange">
                    <p>*за последние 15 дней</p>
                    <p id="valut_price" style="font-weight: bold">1 INFCOIN за ∞ лот</p>
                </div>
                <div style="margin-top: 18px" class="grafik_div">
                    <canvas id="priceChart" width="800" height="200"></canvas>
                </div>
                <div class="your_valut">
                    <div class="upper_my_valut">
                        <p id="valut_balance" class="bolder_text">На вашем счете {{ bills['infcoin'] }} INFCOIN</p>
                        <p id="valut_balance_infcoin" class="thinner_text"></p>
                    </div>
                    <p>
                        Вы можете как продавать так и покупать инвестиции с помощью INFCOIN.<br>
                        Не забывайте, что всю ответственность за проведение сделки несете<br>
                        только вы, поэтому решайте нужно это Вам или нет.
                    </p>.,
                </div>
                <div class="buttons_div">
                    <div id="sell_button" style="margin-left: 34px" class="red_button">Продать | Sell</div>
                    <div id="buy_button" style="background-color: #35B100;margin-right: 34px" class="green_button">
                        Купить | Buy
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Кнопка поддержки -->
<div id="support-btn" title="Поддержка">?</div>

<!-- Окно поддержки -->
<div id="support-popup">
    <div id="support-popup-header">
        <span>Поддержка</span>
        <span id="support-popup-close">&times;</span>
    </div>
    <textarea id="support-message" placeholder="Введите ваш вопрос..." rows="4"></textarea>
    <button id="support-send">Отправить</button>
</div>
<style>
    #support-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        background: #007bff;
        color: #fff;
        border-radius: 50%;
        font-size: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: background 0.2s;
    }
    #support-btn:hover {
        background: #0056b3;
    }

    #support-popup {
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 300px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2);
        z-index: 1001;
        padding: 16px;
        flex-direction: column;
        gap: 12px;
    }

    #support-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-weight: bold;
        font-size: 18px;
    }

    #support-popup-close {
        cursor: pointer;
        font-size: 22px;
        color: #888;
    }

    #support-message {
        width: 100%;
        resize: vertical;
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 8px;
        font-size: 15px;
        margin-bottom: 10px;
    }

    #support-send {
        width: 100%;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        padding: 8px 0;
        cursor: pointer;
        transition: background 0.2s;
    }
    #support-send:hover {
        background: #0056b3;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('support-btn');
    const popup = document.getElementById('support-popup');
    const closeBtn = document.getElementById('support-popup-close');
    const sendBtn = document.getElementById('support-send');
    const msgInput = document.getElementById('support-message');

    if (btn && popup && closeBtn && sendBtn && msgInput) {
        btn.onclick = function() {
            popup.style.display = 'flex';
        };

        closeBtn.onclick = function() {
            popup.style.display = 'none';
        };

        sendBtn.onclick = async function() {
            const msg = msgInput.value.trim();
            if (msg) {
                try {
                    const response = await fetch('/send_message', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ message: msg })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || result.message || 'Неизвестная ошибка сервера');
                    }

                    alert(result.message);
                } catch (error) {
                    console.error('Order error:', error);
                    alert(`Ошибка: ${error.message}`);
                }
                msgInput.value = '';
                popup.style.display = 'none';
            } else {
                alert('Пожалуйста, введите сообщение.');
            }
        };
    } else {
        console.error('Один или несколько элементов не найдены в DOM');
    }
});

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.getElementById("profileClick").addEventListener("click", function (){
        window.location.href = "/profile"
    })
    function generateRandomData(min = 10, max = 50, length = 15) {
        return Array.from({length}, () => Math.floor(Math.random() * (max - min + 1)) + min);
    }

    // Инициализация графика (глобально, чтобы потом обновлять)
    const ctx = document.getElementById('priceChart').getContext('2d');
    const priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['1 мая', '2 мая', '3 мая', '4 мая', '5 мая', '6 мая', '7 мая', '8 мая', 'Пт', 'Сб', 'Вс', 'Пн', 'Вт', 'Ср', 'Чт'],
            datasets: [{
                label: 'Данные актива',
                data: generateRandomData(),
                borderColor: 'rgb(53,171,2)',
                backgroundColor: 'rgba(108,192,75,0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {beginAtZero: false}
            }
        }
    });

    function updateChart() {
        priceChart.data.datasets[0].data = generateRandomData();
        priceChart.update();
    }

    // В обработчике поиска, после вставки нового актива, обновляем график:
    document.getElementById('assetSearch').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            const assetName = this.value.trim().toUpperCase();
            if (assetName) {
                const existingAsset = document.querySelector(`.valutdiv[data-ticker="${assetName}"]`);
                if (existingAsset) {
                    existingAsset.click(); // Открываем карточку, если актив уже существует
                    updateChart(); // Обновляем график
                    this.value = ''; // Очищаем строку поиска
                    return;
                }

                fetch('/create_frame', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `name=${encodeURIComponent(assetName)}`
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text || 'Server error');
                            });
                        }
                        return response.text();
                    })
                    .then(html => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const newAsset = tempDiv.querySelector('.valutdiv');
                        newAsset.setAttribute('data-ticker', assetName);

                        const infElement = document.getElementById('inf');
                        infElement.insertAdjacentElement('afterend', newAsset);

                        // Автоклик по новому активу
                        newAsset.click();
                        this.value = '';

                        // Обновляем график новыми данными
                        updateChart();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Не удалось найти актив. Попробуйте другой тикер.');
                    });
            }
        }
    });


</script>
<script>
    updateBalance()
    document.addEventListener("DOMContentLoaded", function () {
        const exchangeLeft = document.querySelector('.exchange_left');

        exchangeLeft.addEventListener('click', function (event) {
            const valutDiv = event.target.closest('.valutdiv');

            if (!valutDiv || valutDiv.querySelector('input')) return; // игнорируем поиск

            const nameP = valutDiv.querySelector('.valut_left p');
            const img = valutDiv.querySelector('.valut_left img');
            const changeP = valutDiv.querySelector('.invest_up, .invest_down');

            if (!nameP) return;

            const parts = nameP.innerText.trim().split(' ');
            const valut = parts[parts.length - 1]; // последний элемент — тикер (например, GAZP)

            // Обновление UI
            document.getElementById('valut_icon').src = img?.src || '';
            document.getElementById('name_of_valut').innerText = valut;
            document.getElementById('valut_change_percent').innerText = changeP?.innerText || '';
            document.getElementById('valut_balance').innerText = `На вашем счете ${nameP.innerText}`;
            updateBalance()

            // Получение доп. информации с сервера
            fetch(`/get_valut_data/${valut}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('name_of_valut').innerText = data.name;
                    document.getElementById('valut_icon').src = data.icon;
                    document.getElementById('valut_change_percent').innerText = data.change_percent;
                    document.getElementById('valut_price').innerText = data.price;
                    document.getElementById('valut_balance').innerText = `На вашем счете ${data.balance} ${ticker}`;
                    priceChart.data.datasets[0].data = generateRandomData();
                    priceChart.update();
                })

                .catch(err => {
                    console.error("Ошибка при получении данных:", err);
                });
        });
    });

    // Обработчики для кнопок Купить/Продать
    document.getElementById('buy_button').addEventListener('click', () => {
        const ticker = document.getElementById('name_of_valut').textContent.trim();
        placeOrder('Buy');
    });

    document.getElementById('sell_button').addEventListener('click', () => {
        const ticker = document.getElementById('name_of_valut').textContent.trim();
        placeOrder('Sell');
    });

    async function placeOrder(operation) {
        const ticker = document.getElementById('name_of_valut').textContent.trim();
        if (!ticker) {
            alert('Сначала выберите актив из списка слева');
            return;
        }

        try {
            const lotsInput = prompt(`Введите количество лотов для ${operation === 'Buy' ? 'покупки' : 'продажи'}:`);
            if (!lotsInput) return;

            const lots = parseInt(lotsInput);
            if (lots <= 0) {
                throw new Error('Введите корректное количество лотов (целое число больше 0)');
            }

            const response = await fetch('/api/order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ticker: ticker,
                    operation: operation,
                    lots: lots
                })
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || result.message || 'Неизвестная ошибка сервера');
            }

            alert(result.message);
            updateBalance();

        } catch (error) {
            console.error('Order error:', error);
            alert(`Ошибка: ${error.message}`);
        }
    }

    async function updateBalance() {
        try {
            const ticker = document.getElementById('name_of_valut').textContent.trim();
            if (!ticker) return;

            // Получаем обновленные данные
            const response = await fetch(`/get_valut_data/${ticker}`);
            if (!response.ok) throw new Error('Ошибка при получении данных');

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Обновляем UI
            document.getElementById('valut_balance').innerText =
                `На вашем счете ${data.balance} ${ticker}`;
            document.getElementById('valut_in_rubbles').innerText = `${parseFloat(data.rubbles).toFixed(2)}`;

        } catch (error) {
            console.error('Ошибка обновления баланса:', error);
            const ticker = document.getElementById('name_of_valut').textContent.trim();
            document.getElementById('valut_balance').innerText =
                `На вашем счете 0 ${ticker}`;
        }
    }
</script>
</body>
</html>
